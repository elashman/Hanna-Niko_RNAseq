# The samples overview - 

# TRAP elution

# WT
273769 (1 File)
273768 (1 File)
273767 (1 File)

# ST7

273772 (1 File)
273771 (1 File)
273770 (1 File)

# Maco

273775 (1 File)
273774 (1 File)
273773 (1 File)

# TRAP input

# WT


# ST7



# Maco



# load libraries in RStudio
library(dplyr)
library(tximport)
library(DESeq2)
library(rhdf5)
library(ggplot2)
library(plotly)
library(tibble)
library(biomaRt)

gene_map <- read.csv ("map_genes_2.csv")

 # copy all files except .bam (too big) generated by kallisto from cluster to own computer in the folder called kallisto
 scp -r elashman@bea81.hpc.ista.ac.at:/nfs/scistore13/bonogrp/hschoen/TrapSeqreal/27* /Users/elashman/Documents/Nelson_RNASeq_analysis/kallisto
 
 sample_table = read.csv("Info_samples_DEseq2.csv", sep=";")
 sample_files = paste0("./kallisto/", pull(sample_table, "Sample") , "/abundance.h5")
 names(sample_files) = pull(sample_table, "Sample") 

 count_data <- tximport(files = sample_files,type = "kallisto",tx2gene = gene_map, ignoreAfterBar = TRUE)
 count_data[['counts']]

 # specify what samples are control
 conditions = sample_table[,3]
 conditions = factor(conditions, levels = c('WT_elution', 'ST7_elution', 'Macoilin_elution', 'WT_input', 'ST7_input', 'Macoilin_input' )) 
 sample_table$conditions = conditions

 deseq_dataset = DESeqDataSetFromTximport(txi = count_data, colData =sample_table, design = ~conditions)

 ## 3 STEPS in DESeq2 analysis

# STEP 1: estimate size factors (normalizatiion)
deseq_dataset = estimateSizeFactors(deseq_dataset)
normalizationFactors(deseq_dataset)
counts(deseq_dataset, normalized=TRUE)

vst = varianceStabilizingTransformation(deseq_dataset)
plotPCA(vst, intgroup='conditions')

# PCA plot with samples names
plotPCA(vst, intgroup='conditions') + geom_label(aes(label=name))

# FOR WT versus ST7

# Exclude all the samples that are not needed

sample_files_ST7input = sample_files[c(4, 5, 6, 7, 8, 9)]
count_data_ST7input <- tximport(files = sample_files_ST7input,type = "kallisto",tx2gene = gene_map, ignoreAfterBar = TRUE)

# specify what samples are control
 sample_table_ST7input = read.csv("Info_samples_DEseq2_ST7input.csv", sep=";")
 conditions = sample_table_ST7input[,3]
 conditions = factor(conditions, levels = c('WT_elution', 'ST7_elution')) 
 sample_table_ST7input$conditions = conditions

  deseq_dataset_ST7input = DESeqDataSetFromTximport(txi = count_data_ST7input, colData = sample_table_ST7input, design = ~conditions)

   # estimate size factors (normalizatiion)
deseq_dataset_ST7input = estimateSizeFactors(deseq_dataset_ST7input)
normalizationFactors(deseq_dataset_ST7input)
counts(deseq_dataset_ST7input, normalized=TRUE)

vst_ST7input = varianceStabilizingTransformation(deseq_dataset_ST7input)
plotPCA(vst_ST7input, intgroup='conditions')

# estimate dispersions

deseq_dataset_ST7input = estimateDispersions(deseq_dataset_ST7input)
plotDispEsts(deseq_dataset_ST7input)


# Run statistics 
deseq_dataset_ST7input = nbinomWaldTest(deseq_dataset_ST7input)
result_table_ST7input = results(deseq_dataset_ST7input)
summary(result_table_ST7input)

out of 19719 with nonzero total read count
adjusted p-value < 0.1
LFC > 0 (up)       : 0, 0%
LFC < 0 (down)     : 2, 0.01%
outliers [1]       : 202, 1%
low counts [2]     : 0, 0%
(mean count < 0)
[1] see 'cooksCutoff' argument of ?results
[2] see 'independentFiltering' argument of ?results

# result_table_analysis2 is DataFrame not data.frame! To make it data.frame
result_df_ST7input = as.data.frame(result_table_ST7input)

# plot counts for  WBGene00003807
dds = deseq_dataset_ST7input
plotCounts(dds, 'WBGene00003807', intgroup ='conditions', normalized = TRUE)
plotCounts(dds, 'WBGene00003807', intgroup ='conditions', normalized = FALSE)


